doParallel::registerDoParallel(cl = my.cluster)
models = foreach(i = 1:(sum(str_detect(names(df), "^rna[0-9]*$"))+1)) %dopar% {
if(i == 1){
try(spotsInla(df, W, "prot", character(), aar = aar, neighbors = T, family = c("poisson", "poisson")))
} else{
try(spotsInla(df, W, "prot", paste("rna",1:(i-1),sep=""), aar = aar, neighbors = T, family = c("poisson", "poisson")))
}
}
library(foreach)
my.cluster <- parallel::makeCluster(6)
parallel::clusterEvalQ(my.cluster, {
source('parlibs.R')
})
doParallel::registerDoParallel(cl = my.cluster)
models = foreach(i = 1:(sum(str_detect(names(df), "^rna[0-9]*$"))+1)) %dopar% {
if(i == 1){
try(spotsInla(df, W, "prot", character(), aar = aar, neighbors = T, family = c("poisson", "poisson")))
} else{
try(spotsInla(df, W, "prot", paste("rna",1:(i-1),sep=""), aar = aar, neighbors = T, family = c("poisson", "poisson")))
}
}
parallel::stopCluster(cl = my.cluster)
aar = c("pulp", "bf", "mz", "pals")
dat = predData("CD4", NULL, spots, aar, geneindex = 1:200, genepair = "Cd4")
dat$top_preds
df = dat$df
pred_idx = which(df$imagecol > 290 & df$imagecol < 390 & df$imagerow < 310 & df$imagerow > 210)
df_pred = df[pred_idx,]
df$prot[pred_idx] = NA
coordsmat = cbind(df$imagerow, df$imagecol)
W = matrix(0, nrow(coordsmat), nrow(coordsmat))
for(i in 1:nrow(W)){
for(j in i:nrow(W)){
cp = crossprod(coordsmat[i,] - coordsmat[j,])
if(cp > 0 && cp < 45){
W[i,j] = 1
W[j,i] = 1
}
}
}
my.cluster <- parallel::makeCluster(6)
parallel::clusterEvalQ(my.cluster, {
source('parlibs.R')
})
doParallel::registerDoParallel(cl = my.cluster)
models = foreach(i = 1:(sum(str_detect(names(df), "^rna[0-9]*$"))+1)) %dopar% {
if(i == 1){
try(spotsInla(df, W, "prot", character(), aar = aar, neighbors = T, family = c("poisson", "poisson")))
} else{
try(spotsInla(df, W, "prot", paste("rna",1:(i-1),sep=""), aar = aar, neighbors = T, family = c("poisson", "poisson")))
}
}
df$idx
df$prot
aar
m1 = try(spotsInla(df, W, "prot", character(), aar = aar, neighbors = T, family = c("poisson", "poisson")))
displayResults(list(m1), df, df_pred, T)
source("../scripts/utils.R")
displayResults(models, df, df_pred, T)
displayResults(list(m1), df, df_pred, T)
my.cluster <- parallel::makeCluster(6)
parallel::clusterEvalQ(my.cluster, {
source('parlibs.R')
})
doParallel::registerDoParallel(cl = my.cluster)
models = foreach(i = 1:(sum(str_detect(names(df), "^rna[0-9]*$"))+1)) %dopar% {
if(i == 1){
try(spotsInla(df, W, "prot", character(), aar = aar, neighbors = T, family = c("poisson", "poisson")))
} else{
try(spotsInla(df, W, "prot", paste("rna",1:(i-1),sep=""), aar = aar, neighbors = T, family = c("poisson", "poisson")))
}
}
parallel::stopCluster(cl = my.cluster)
m
displayResults(models, df, df_pred, T)
getwd()
parallel::stopCluster(cl = my.cluster)
source("../scripts/SPOTS/helpers.R")
source("../scripts/utils.R")
source("../INLA/LCAR.R")
source("../INLA/MCAR.R")
source("../INLA/indepMCAR.R")
source("../INLA/CCAR.R")
source("../INLA/MCCAR.R")
source("../INLA/spotCCAR.R")
source("../INLA/spotMCCAR.R")
breast = readSpotscancerlist("~/Documents/postdoc/MCAR/data/spots/cancer/")
aar = c("fbh", "fbl", "mac2", "unknown", "lymph", "mac1")
df = data.frame("spot" = dimnames(breast$Protein)[[2]],
"prot" = unname(breast$Protein[which(rownames(breast$Protein) == "Podoplanin"),]),
"size_prot" = unname(colSums(breast$Protein)) / median(colSums(breast$Protein)),
"size_rna" = unname(colSums(breast$RNA)) / median(colSums(breast$RNA)),
"idx" = 1:ncol(breast$Protein)) %>%
full_join(., breast$coords, by = "spot") %>%
full_join(breast$AAR, by = "spot") %>%
select(!AARs)
rna = data.frame(t(breast$RNA), row.names = c()) %>% select(all_of(c("Pdpn", "Sparc")))
names(rna) = paste("rna", 1:ncol(rna), sep = "")
df = cbind(df, rna)
set.seed(1); pred_idx = sample(1:nrow(df), 200)
coordsmat = cbind(df$imagerow, df$imagecol)
W = matrix(0, nrow(coordsmat), nrow(coordsmat))
for(i in 1:nrow(W)){
for(j in i:nrow(W)){
cp = crossprod(coordsmat[i,] - coordsmat[j,])
if(cp > 0 && cp < 55){
W[i,j] = 1
W[j,i] = 1
}
}
}
W2 = W
W = matrix(0, nrow(df), nrow(df))
for(i in 1:nrow(W)){
for(j in i:nrow(W)){
cp = crossprod(c(df$imagerow[i], df$imagecol[i]) - c(df$imagerow[j], df$imagecol[j]))
#cp = crossprod(coordsmat[i,] - coordsmat[j,])
if(cp > 0 && cp < 55){
W[i,j] = 1
W[j,i] = 1
}
}
}
all(W == W2)
str_detect(names(df), "^rna[0-9]*$"))
str_detect(names(df), "^rna[0-9]*$")
sum(str_detect(names(df), "^rna[0-9]*$"))
i = 3
paste("rna",1:(i-1),sep="")
library(INLA)
library(scico)
source("../scripts/SPOTS/helpers.R")
source("../INLA/LCAR.R")
source("../INLA/MCAR.R")
source("../INLA/CCAR.R")
source("../INLA/spotCCAR.R")
source("../INLA/MCCAR.R")
source("../INLA/spotMCCAR.R")
df = SpotsCancerData("~/Documents/postdoc/MCAR/data/spots/cancer/", genes) %>%
select(!c(AARs, spot)) %>%
mutate(idx = 1:nrow(.))
fig_pairs = list("CD3" = "Cd3e",
"F480" = "Adgre1",
"CD163" = "Cd163",
"CD29" = "Itgb1",
"CD68" = "Cd68",
"IgM" = "Ighm",
"CD38" = "Cd38",
"MadCAM1" = "Madcam1",
"EpCAM" = "Epcam",
"CD11b" = "Itgam",
"CD105" = "Eng",
"CD31" = "Pecam1",
"CD20" = "Ms4a1",
"CD169" = "Siglec1",
"IgD" = "Ighd",
"CD4" = "Cd4",
"CD8" = "Cd8a",
"CD19" = "Cd19",
"B220" = "Ptprc")
## SPLEEN
df = SpotsProteinData("~/Documents/postdoc/MCAR/data/spots/spleen/", fig_pairs)
#Visualize the AARs
df %>%
mutate(AARs = as.factor(AARs)) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set2") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
df
SpotsProteinData = function(loc, genepairs){
spotsdata = readSpotsSpleen("~/Documents/postdoc/MCAR/data/spots/spleen/", 2)
# calculate sizes jointly (i.e. not slidewise)
prot = cbind(spotsdata$protein1, spotsdata$protein2)
RNA = cbind(spotsdata$RNA1, spotsdata$RNA2)
rna_size = unname(colSums(RNA)) / median(colSums(RNA))
protein_size = unname(colSums(prot)) / median(colSums(prot))
# Create a dataframe for slide 1 with the genes matching the proteins
rna_1 = as.data.frame(t(spotsdata$RNA1)) %>%
select(unname(sapply(genepairs, c))) %>%
mutate(spot = colnames(spotsdata$RNA1),
size_rna = rna_size[1:nrow(.)])
prot_1 = as.data.frame(t(spotsdata$protein1)) %>%
mutate(spot = colnames(spotsdata$protein1),
size_prot = protein_size[1:nrow(.)])
df_1 = full_join(rna_1, prot_1, by = "spot") %>%
full_join(spotsdata$coords1, by = "spot") %>%
full_join(spotsdata$AAR1, by = "spot")
# Create a dataframe for slide 2 with the genes matching the proteins
rna_2 = as.data.frame(t(spotsdata$RNA2)) %>%
select(unname(sapply(genepairs, c))) %>%
mutate(spot = colnames(spotsdata$RNA2),
size_rna = rna_size[(nrow(rna_1)+1):length(rna_size)])
prot_2 = as.data.frame(t(spotsdata$protein2)) %>%
mutate(spot = colnames(spotsdata$protein2),
size_prot = protein_size[(nrow(rna_1)+1):length(protein_size)])
df_2 = full_join(rna_2, prot_2, by = "spot") %>%
full_join(spotsdata$coords2, by = "spot") %>%
right_join(spotsdata$AAR2, by = "spot")
# move replicate 1 to the right of replicate 2
df_2$imagecol = df_2$imagecol + (max(df_1$imagecol)-min(df_2$imagecol)) + 5
df = rbind(df_1, df_2) %>% mutate(idx = 1:nrow(.)) #%>% select(!AARs)
names(df)[str_detect(names(df), "-")] = c("F480", "CD169", "B220")
return(df)
}
## SPLEEN
df = SpotsProteinData("~/Documents/postdoc/MCAR/data/spots/spleen/", fig_pairs)
#Visualize the AARs
df %>%
mutate(AARs = as.factor(AARs)) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set2") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = as.factor(AARs)) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set3") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = as.factor(AARs)) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set4") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = as.factor(AARs)) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set1") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = as.factor(AARs)) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set2") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = factor(AARs, levels = c("Red pulp", "PALS", "Marginal zone", "B follicle"))) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set2") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = factor(AARs, levels = c("PALS","Red pulp", "Marginal zone", "B follicle"))) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set2") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#Visualize the AARs
df %>%
mutate(AARs = factor(AARs, levels = c("PALS","Marginal zone","Red pulp", "B follicle"))) %>%
ggplot() + geom_point(aes(x = imagecol, y = imagerow, color = AARs)) +
scale_color_brewer(palette = "Set2") +
theme_bw() +
theme(text = element_text(size = 14),
legend.text.align = 0,
legend.title.align=0.2,
panel.grid.major = element_blank(),
panel.grid.minor = element_blank(),
legend.text=element_text(size=10),
#panel.spacing.y = unit(0.8, "lines"),
axis.title.x=element_blank(),
axis.text.x=element_blank(),
axis.ticks.x=element_blank(),
axis.title.y=element_blank(),
axis.text.y=element_blank(),
axis.ticks.y=element_blank(),
legend.position="bottom")
#ggsave("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/aarcolor.png", width = 9, height = 5, dpi=700)
ggsave(paste("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/pdfplots/spleen", "/annotation.pdf", sep = ""), width = 7.4, height = 3.9, dpi=600)
#ggsave("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/aarcolor.png", width = 9, height = 5, dpi=700)
ggsave(paste("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/pdfplots/spleen", "/annotation.pdf", sep = ""), width = 8, height = 5, dpi=600)
#ggsave("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/aarcolor.png", width = 9, height = 5, dpi=700)
ggsave(paste("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/pdfplots/spleen", "/annotation.pdf", sep = ""), width = 9, height = 5, dpi=600)
#ggsave("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/aarcolor.png", width = 9, height = 5, dpi=700)
ggsave(paste("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/pdfplots/spleen", "/annotation.pdf", sep = ""), width = 9, height = 5.2, dpi=600)
library(INLA)
source("../scripts/SPOTS/helpers.R")
source("../INLA/LCAR.R")
source("../INLA/MCAR.R")
source("../INLA/CCAR.R")
source("../INLA/MCCAR.R")
fig_pairs = list("CD3" = "Cd3e",
"F480" = "Adgre1",
"CD163" = "Cd163",
"CD29" = "Itgb1",
"CD68" = "Cd68",
"IgM" = "Ighm",
"CD38" = "Cd38",
"MadCAM1" = "Madcam1",
"EpCAM" = "Epcam",
"CD11b" = "Itgam",
"CD105" = "Eng",
"CD31" = "Pecam1",
"CD20" = "Ms4a1",
"CD169" = "Siglec1",
"IgD" = "Ighd",
"CD4" = "Cd4",
"CD8" = "Cd8a",
"CD19" = "Cd19",
"B220" = "Ptprc")
## SPLEEN
df = SpotsProteinData("~/Documents/postdoc/MCAR/data/spots/spleen/", fig_pairs)
fig_pairs[16]
protid = 16
df
# Recreate CD3 row
PROT = 4
# Protein-gene pair
preds = fig_pairs[[PROT]]
preds
coordsmat = cbind(df$imagerow, df$imagecol)
W = matrix(0, nrow(coordsmat), nrow(coordsmat))
for(i in 1:nrow(W)){
for(j in i:nrow(W)){
cp = crossprod(coordsmat[i,] - coordsmat[j,])
if(cp > 0 && cp < 45){
W[i,j] = 1
W[j,i] = 1
}
}
}
# Protein-gene pair
preds = fig_pairs[[PROT]]
ccar = spotsInla(df, W, names(fig_pairs)[PROT], preds)
aar = c("pulp", "bf", "mz", "pals")
ccar = spotsInla(df, W, names(fig_pairs)[PROT], preds, aar)
## Script prediction on the spots spleen
library(INLA)
library(scico)
library(tidyverse)
library(foreach)
library(rstan)
source("../scripts/SPOTS/helpers.R")
source("../scripts/utils.R")
source("../INLA/LCAR.R")
source("../INLA/MCAR.R")
source("../INLA/CCAR.R")
source("../INLA/MCCAR.R")
# CD4 prediction example
spots = readSpotsSpleen("~/Documents/postdoc/MCAR/data/spots/spleen/")
aar = c("pulp", "bf", "mz", "pals")
names(spots)[2] = "Protein"
dat = predData("CD4", NULL, spots, aar, geneindex = 1:200, genepair = "Cd4")
df = dat$df
pred_idx = which(df$imagecol > 290 & df$imagecol < 390 & df$imagerow < 310 & df$imagerow > 210)
df_pred = df[pred_idx,]
df$prot[pred_idx] = NA
coordsmat = cbind(df$imagerow, df$imagecol)
W = matrix(0, nrow(coordsmat), nrow(coordsmat))
for(i in 1:nrow(W)){
for(j in i:nrow(W)){
cp = crossprod(coordsmat[i,] - coordsmat[j,])
if(cp > 0 && cp < 45){
W[i,j] = 1
W[j,i] = 1
}
}
}
m = spotsInla(df, W, "prot", "rna1", aar = aar, neighbors = T, family = c("poisson", "poisson"))
load("/Users/lukar818/Documents/postdoc/research/RnaProt/plots/cortext/CD4_cortex.RData")
temp = models
temp = model
model$ccar = m
model$ccar
model
model[c(1,5,2,3,4)]
model = model[c(1,5,2,3,4)]
model
names(model)
?save(model)
save(model, file = "/Users/lukar818/Documents/postdoc/research/RnaProt/plots/cortext/CD4_cortex.RData")
df
df
# cd4glm
## GLMS
# cd4glm
protform <- as.formula(paste(paste("prot", "~"), paste(aar[-1],collapse = "+")))
protform
mc.car <- inla(protform, data = df, family = "poisson",
offset = log(size_prot),
control.predictor = list(compute = TRUE, link = 1))
glmcd4 <- inla(protform, data = df, family = "poisson",
offset = log(size_prot),
control.predictor = list(compute = TRUE, link = 1))
summary(glmcd4)
glmcd4$summary.fitted.values[pred_idx]
glmcd4$summary.fitted.values$mean[pred_idx]
rownames(spots$Protein)
dat = predData("F4-80", NULL, spots, aar, geneindex = 1:200, genepair = "Adgre1")
df = dat$df
pred_idx = which(df$imagecol > 290 & df$imagecol < 390 & df$imagerow < 310 & df$imagerow > 210)
df_pred = df[pred_idx,]
df$prot[pred_idx] = NA
glmf480 <- inla(protform, data = df, family = "poisson",
offset = log(size_prot),
control.predictor = list(compute = TRUE, link = 1))
summary(glmf480)
glms = list("cd4" = glmcd4, "f480" = glmf480)
save(glms, file = "/Users/lukar818/Documents/postdoc/research/RnaProt/plots/other/glmsSpleen.RData")
